{% extends 'leads/base.html' %}
{% load static %}

{% block title %}{{ lead.company_name }} - Order Tracking{% endblock %}

{% block content %}
<style>
  /* Add toast notification styles */
  .toast-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 9999;
  }

  .toast {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    min-width: 300px;
    max-width: 400px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(120%);
    transition: transform 0.3s ease-out;
    position: relative;
    overflow: hidden;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
  }

  .toast-success::before {
    background: var(--success);
  }

  .toast-warning::before {
    background: var(--warning);
  }

  .toast-error::before {
    background: var(--error);
  }

  .toast-info::before {
    background: var(--info);
  }

  .toast-icon {
    font-size: 20px;
  }

  .toast-success .toast-icon { color: var(--success); }
  .toast-warning .toast-icon { color: var(--warning); }
  .toast-error .toast-icon { color: var(--error); }
  .toast-info .toast-icon { color: var(--info); }

  .toast-content {
    flex: 1;
  }

  .toast-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--text);
  }

  .toast-message {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 20px;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .toast-close:hover {
    background: var(--bg);
    color: var(--text);
  }

  :root {
    --primary: #1a1a1a;
    --bg: #fafafa;
    --card-bg: #ffffff;
    --border: #e5e5e5;
    --text: #1a1a1a;
    --text-secondary: #666;
    --text-muted: #999;
    --success: #16a34a;
    --warning: #f59e0b;
    --info: #3b82f6;
    --error: #ef4444;
    --purple: #9333ea;
    --gradient-1: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 60px;
  }

  .container {
    margin-top: 80px;
    padding: 40px;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
  }

  /* ============================================
     TOP HEADER WITH EXPANDED CLIENT INFO
     ============================================ */
  .lead-header {
    background: var(--gradient-1);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    color: white;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  }

  .lead-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
  }

  .header-content {
    position: relative;
    z-index: 1;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .lead-title {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: -1px;
    margin-bottom: 8px;
  }

  .lead-id {
    font-family: "SF Mono", monospace;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.2);
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
  }

  .stage-badge {
    padding: 10px 20px;
    border-radius: 24px;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .stage-costing_created { background: #e0e7ff; color: #4338ca; }
  .stage-quotation_created { background: #dbeafe; color: #1e40af; }
  .stage-quotation_sent { background: #bfdbfe; color: #1e3a8a; }
  .stage-quotation_revision { background: #fef3c7; color: #92400e; }
  .stage-quotation_accepted { background: #d1fae5; color: #065f46; }
  .stage-po_received { background: #dcfce7; color: #166534; }
  .stage-oa_created { background: #e0e7ff; color: #4338ca; }
  .stage-oa_sent { background: #ddd6fe; color: #5b21b6; }
  .stage-oa_revision { background: #fed7aa; color: #9a3412; }
  .stage-oa_accepted { background: #bbf7d0; color: #14532d; }
  .stage-order_completed { background: #86efac; color: #14532d; }
  .stage-order_lost { background: #fee2e2; color: #991b1b; }

  /* Header Info Grid */
  .header-info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 16px;
  }

  .header-info-item {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-icon {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .header-text {
    flex: 1;
    min-width: 0;
  }

  .header-label {
    font-size: 11px;
    opacity: 0.75;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .header-value {
    font-size: 15px;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ============================================
     PROGRESS TRACKER
     ============================================ */
  .progress-tracker {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .progress-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 40px;
  }

  .progress-line {
    position: absolute;
    top: 20px;
    left: 5%;
    right: 5%;
    height: 4px;
    background: var(--border);
    z-index: 0;
  }

  .progress-line-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--info));
    transition: width 0.5s ease;
  }

  .progress-step {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    cursor: pointer;
  }

  .step-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--card-bg);
    border: 4px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    margin-bottom: 12px;
  }

  .progress-step.completed .step-circle {
    background: var(--success);
    border-color: var(--success);
    color: white;
  }

  .progress-step.active .step-circle {
    background: var(--info);
    border-color: var(--info);
    color: white;
    box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.2);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.2); }
    50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0.1); }
  }

  .step-label {
    font-size: 12px;
    font-weight: 600;
    text-align: center;
    color: var(--text-secondary);
    max-width: 100px;
  }

  .progress-step.completed .step-label,
  .progress-step.active .step-label {
    color: var(--text);
  }

  /* Latest Update Box */
  .latest-update {
    background: var(--bg);
    padding: 16px;
    border-radius: 10px;
    border-left: 4px solid var(--info);
  }

  .update-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .update-text {
    font-size: 14px;
    color: var(--text);
  }

  /* ============================================
     UNIFIED TANK DETAILS CARD
     ============================================ */
  .tank-details-card {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .card-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .tank-top-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 24px;
  }

  .info-field {
    background: var(--bg);
    padding: 16px;
    border-radius: 10px;
  }

  .info-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  .info-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }

  /* Tank Grid Table */
  .tank-grid {
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  .tank-grid-header {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1fr;
    gap: 16px;
    padding: 14px 20px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
  }

  .grid-header-cell {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tank-grid-row {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1fr;
    gap: 16px;
    padding: 16px 20px;
    background: var(--card-bg);
    border-bottom: 1px solid var(--border);
    align-items: center;
  }

  .tank-grid-row:last-child {
    border-bottom: none;
  }

  .tank-grid-row:hover {
    background: var(--bg);
  }

  .grid-cell {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }

  .tank-empty {
    text-align: center;
    padding: 48px;
    color: var(--text-secondary);
    background: var(--bg);
  }

  /* ============================================
     STAGE UPDATE FORM
     ============================================ */
  .stage-update-card {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .update-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .update-title {
    font-size: 18px;
    font-weight: 700;
    flex: 1;
  }

  .dropdown-container {
    position: relative;
    flex: 1;
    max-width: 400px;
  }

  .dropdown-trigger {
    width: 100%;
    padding: 14px 16px;
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 15px;
    font-weight: 600;
  }

  .dropdown-trigger:hover {
    border-color: var(--primary);
  }

  .dropdown-trigger.open {
    border-color: var(--info);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    max-height: 400px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }

  .dropdown-menu.show {
    display: block;
    animation: slideDown 0.2s ease-out;
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .dropdown-item {
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .dropdown-item:last-child {
    border-bottom: none;
  }

  .dropdown-item:hover {
    background: var(--bg);
  }

  .dropdown-item.selected {
    background: rgba(59, 130, 246, 0.05);
    color: var(--info);
    font-weight: 600;
  }

  .update-form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 24px;
  }

  .form-label {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    background: var(--card-bg);
    color: var(--text);
    transition: all 0.2s;
    font-family: inherit;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(26, 26, 26, 0.05);
  }

  .form-textarea {
    min-height: 120px;
    resize: vertical;
  }

  .btn {
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    border: none;
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success), #15803d);
    color: white;
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    width: 100%;
    justify-content: center;
  }

  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(22, 163, 74, 0.4);
  }

  /* ============================================
     MEETING SCHEDULER
     ============================================ */
  .meeting-card {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .meeting-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  /* ============================================
     FINAL DECISION HUB (NEW FEATURE)
     ============================================ */
  .decision-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  }

  .decision-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .decision-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }

  .decision-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .decision-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  .decision-btn {
    padding: 28px 20px;
    border-radius: 12px;
    border: 2px solid;
    background: var(--card-bg);
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .decision-icon {
    font-size: 40px;
    margin-bottom: 12px;
  }

  .decision-label {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .decision-desc {
    font-size: 13px;
    opacity: 0.7;
  }

  /* Button Colors */
  .decision-btn.regret {
    border-color: var(--error);
    color: var(--error);
  }

  .decision-btn.regret:hover {
    background: var(--error);
    color: white;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
  }

  .decision-btn.lost {
    border-color: var(--warning);
    color: var(--warning);
  }

  .decision-btn.lost:hover {
    background: var(--warning);
    color: white;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
  }

  .decision-btn.customer {
    border-color: var(--success);
    color: var(--success);
  }

  .decision-btn.customer:hover {
    background: var(--success);
    color: white;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(22, 163, 74, 0.3);
  }

  /* ============================================
     MODAL FOR FINAL REMARK
     ============================================ */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal-content {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
    animation: modalPop 0.3s ease-out;
  }

  @keyframes modalPop {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .modal-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .modal-icon.regret {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
  }

  .modal-icon.lost {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
  }

  .modal-icon.customer {
    background: rgba(22, 163, 74, 0.1);
    color: var(--success);
  }

  .modal-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }

  .modal-body {
    margin-bottom: 24px;
  }

  .modal-description {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
  }

  .btn-modal-cancel {
    flex: 1;
    padding: 12px 20px;
    background: transparent;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text);
  }

  .btn-modal-cancel:hover {
    background: var(--bg);
  }

  .btn-modal-confirm {
    flex: 1;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    color: white;
  }

  .btn-modal-confirm.regret {
    background: var(--error);
  }

  .btn-modal-confirm.lost {
    background: var(--warning);
  }

  .btn-modal-confirm.customer {
    background: var(--success);
  }

  .btn-modal-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* ============================================
     HISTORY SECTION
     ============================================ */
  .history-card {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .timeline {
    position: relative;
    padding-left: 32px;
  }

  .timeline::before {
    content: "";
    position: absolute;
    left: 12px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border);
  }

  .timeline-item {
    position: relative;
    padding-bottom: 32px;
  }

  .timeline-item:last-child {
    padding-bottom: 0;
  }

  .timeline-dot {
    position: absolute;
    left: -25px;
    top: 4px;
    width: 28px;
    height: 28px;
    background: var(--card-bg);
    border: 3px solid var(--info);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 0 4px var(--card-bg);
  }

  .timeline-dot.success {
    border-color: var(--success);
  }

  .timeline-dot.warning {
    border-color: var(--warning);
  }

  .timeline-content {
    background: var(--bg);
    padding: 16px;
    border-radius: 10px;
    border-left: 3px solid var(--info);
  }

  .timeline-content.success {
    border-left-color: var(--success);
  }

  .timeline-content.warning {
    border-left-color: var(--warning);
  }

  .timeline-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .timeline-meta {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  .timeline-text {
    font-size: 14px;
    color: var(--text);
    line-height: 1.5;
  }

  /* ============================================
     RESPONSIVE
     ============================================ */
  @media (max-width: 1200px) {
    .header-info-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .decision-options {
      grid-template-columns: 1fr;
    }

    .toast-container {
      left: 20px;
      right: 20px;
    }

    .toast {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .container {
      padding: 20px;
    }

    .header-info-grid {
      grid-template-columns: 1fr;
    }

    .tank-top-info {
      grid-template-columns: 1fr;
    }

    .tank-grid-header,
    .tank-grid-row {
      grid-template-columns: 1fr;
    }

    .grid-header-cell {
      display: none;
    }

    .meeting-form-grid {
      grid-template-columns: 1fr;
    }

    .toast-container {
      top: 80px;
      left: 10px;
      right: 10px;
    }

    .toast {
      min-width: auto;
      width: 100%;
    }
  }



   /* ============================================
     FLATPICKR CUSTOM THEME
     ============================================ */
  .flatpickr-calendar {
    background: #ffffff;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  .flatpickr-months {
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    border-radius: 12px 12px 0 0;
    padding: 16px;
  }

  .flatpickr-month {
    color: white;
  }

  .flatpickr-current-month {
    font-size: 16px;
    font-weight: 600;
    color: white;
  }

  .flatpickr-prev-month,
  .flatpickr-next-month {
    fill: white;
    opacity: 0.8;
    transition: opacity 0.2s;
  }

  .flatpickr-prev-month:hover,
  .flatpickr-next-month:hover {
    opacity: 1;
  }

  .flatpickr-weekdays {
    background: #f9fafb;
    padding: 12px 0;
  }

  .flatpickr-weekday {
    color: #666666;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .flatpickr-days {
    padding: 8px;
  }

  .flatpickr-day {
    border-radius: 8px;
    color: #1a1a1a;
    font-weight: 500;
    transition: all 0.2s;
  }

  .flatpickr-day:hover {
    background: #f3f4f6;
    border-color: #f3f4f6;
  }

  .flatpickr-day.today {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
    color: #3b82f6;
    font-weight: 600;
  }

  .flatpickr-day.selected {
    background: #1a1a1a;
    border-color: #1a1a1a;
    color: white;
    font-weight: 600;
  }

  .flatpickr-day.selected:hover {
    background: #333;
    border-color: #333;
  }

  .flatpickr-time {
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    border-radius: 0 0 12px 12px;
    padding: 12px;
  }

  .flatpickr-time input {
    color: #1a1a1a;
    font-weight: 600;
  }

  .flatpickr-am-pm {
    color: #1a1a1a;
    font-weight: 600;
  }

  /* Input field with calendar icon indicator */
  input[type="date"],
  input[type="datetime-local"] {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666666' stroke-width='2'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 40px;
  }

  input[type="date"]:focus,
  input[type="datetime-local"]:focus {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231a1a1a' stroke-width='2'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
  }
  
  /* ============================================
   MOBILE-FIRST RESPONSIVE DESIGN
   ============================================ */

/* Base mobile styles */
@media screen and (max-width: 768px) {
  /* Container adjustments */
  .container {
    margin-top: 60px;
    padding: 16px;
  }

  /* Header optimizations */
  .lead-header {
    padding: 24px 16px;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .header-top {
    flex-direction: column;
    gap: 16px;
    align-items: flex-start;
  }

  .lead-title {
    font-size: 24px;
    line-height: 1.3;
    margin-bottom: 8px;
  }

  .stage-badge {
    align-self: flex-start;
    padding: 8px 16px;
    font-size: 12px;
  }

  .header-info-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .header-info-item {
    gap: 12px;
  }

  .header-icon {
    width: 36px;
    height: 36px;
    min-width: 36px;
  }

  .header-value {
    font-size: 14px;
    word-break: break-word;
    white-space: normal;
  }

  /* Progress tracker mobile optimization */
  .progress-tracker {
    padding: 24px 16px;
    margin-bottom: 24px;
    overflow-x: auto;
  }

  .progress-title {
    font-size: 18px;
    margin-bottom: 24px;
  }

  .progress-steps {
    min-width: 600px; /* Allow horizontal scrolling on small devices */
    padding-bottom: 16px;
    margin-bottom: 24px;
  }

  .progress-step {
    min-width: 70px;
  }

  .step-circle {
    width: 36px;
    height: 36px;
    font-size: 12px;
    margin-bottom: 8px;
  }

  .step-label {
    font-size: 10px;
    max-width: 70px;
    line-height: 1.2;
  }

  /* Cards mobile optimization */
  .tank-details-card,
  .stage-update-card,
  .meeting-card,
  .decision-card,
  .history-card {
    padding: 20px 16px;
    margin-bottom: 20px;
    border-radius: 12px;
  }

  .card-title {
    font-size: 16px;
    margin-bottom: 20px;
  }

  /* Tank details mobile */
  .tank-top-info {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .tank-grid-header {
    display: none; /* Hide header on mobile */
  }

  .tank-grid-row {
    grid-template-columns: 1fr;
    gap: 8px;
    padding: 16px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }

  .tank-grid-row:before {
    content: attr(data-label);
    font-size: 10px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  /* Form optimizations for mobile */
  .update-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  .dropdown-container {
    max-width: 100%;
    width: 100%;
  }

  .update-form-grid,
  .meeting-form-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .form-input,
  .form-textarea {
    padding: 12px 14px;
    font-size: 14px;
  }

  .btn {
    padding: 12px 20px;
    font-size: 14px;
    width: 100%;
    justify-content: center;
  }

  /* Decision hub mobile */
  .decision-card {
    padding: 24px 16px;
  }

  .decision-options {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .decision-btn {
    padding: 20px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
  }

  .decision-icon {
    font-size: 32px;
    margin-bottom: 0;
    flex-shrink: 0;
  }

  .decision-label {
    font-size: 15px;
    margin-bottom: 4px;
  }

  .decision-desc {
    font-size: 12px;
  }

  /* Timeline mobile */
  .timeline {
    padding-left: 20px;
  }

  .timeline-dot {
    width: 24px;
    height: 24px;
    left: -18px;
  }

  .timeline-content {
    padding: 12px;
  }

  /* Toast notifications mobile */
  .toast-container {
    top: 70px;
    left: 10px;
    right: 10px;
  }

  .toast {
    min-width: auto;
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 8px;
  }

  /* Modal mobile */
  .modal-content {
    width: 95%;
    padding: 20px;
    margin: 10px;
  }

  .modal-actions {
    flex-direction: column;
    gap: 8px;
  }

  .btn-modal-cancel,
  .btn-modal-confirm {
    width: 100%;
  }
}

/* Medium mobile devices (landscape) */
@media screen and (min-width: 481px) and (max-width: 768px) {
  .header-info-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .progress-steps {
    min-width: auto;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }

  .progress-step {
    flex: 0 0 calc(33.333% - 8px);
    margin-bottom: 16px;
  }

  .progress-line {
    display: none; /* Hide line on wrapped layout */
  }

  .tank-top-info {
    grid-template-columns: repeat(2, 1fr);
  }

  .decision-options {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Small mobile devices (portrait) */
@media screen and (max-width: 480px) {
  /* Extra small adjustments */
  .lead-title {
    font-size: 22px;
  }

  .progress-steps {
    gap: 4px;
  }

  .step-label {
    font-size: 9px;
  }

  .decision-btn {
    flex-direction: column;
    text-align: center;
    gap: 8px;
  }

  .decision-icon {
    margin-bottom: 4px;
  }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  /* Larger tap targets */
  .dropdown-trigger,
  .btn,
  .decision-btn,
  .dropdown-item {
    min-height: 44px; /* Apple's recommended minimum */
  }

  .step-circle {
    width: 44px;
    height: 44px;
  }

  /* Remove hover effects */
  .btn-success:hover,
  .decision-btn:hover {
    transform: none;
  }

  /* Improve form input accessibility */
  .form-input,
  .form-textarea,
  .dropdown-trigger {
    font-size: 16px; /* Prevent iOS zoom */
  }

  /* Increase spacing for touch */
  .update-form-grid,
  .meeting-form-grid {
    gap: 20px;
  }
}

/* Dark mode support for mobile */
@media (prefers-color-scheme: dark) and (max-width: 768px) {
  :root {
    --bg: #121212;
    --card-bg: #1e1e1e;
    --border: #333;
    --text: #ffffff;
    --text-secondary: #aaa;
  }

  .progress-step .step-circle {
    background: var(--card-bg);
  }

  .info-field {
    background: rgba(255, 255, 255, 0.05);
  }
}

/* Fix for iOS specific issues */
@supports (-webkit-touch-callout: none) {
  .container {
    /* Prevent elastic scrolling on iOS */
    overscroll-behavior: none;
  }

  .form-input,
  .form-textarea {
    /* Fix for iOS rounded corners */
    -webkit-appearance: none;
    border-radius: 10px;
  }
}

/* Prevent horizontal scrolling on mobile */
body {
  overflow-x: hidden;
  max-width: 100vw;
}

/* Smooth scrolling for mobile */
@media (max-width: 768px) {
  html {
    scroll-behavior: smooth;
  }
}
</style>

<!-- Toast Notification Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Django Messages as JSON (PRODUCTION-GRADE SOLUTION) -->
{% if messages %}
<script id="django-messages" type="application/json">
  [
    {% for message in messages %}
      {
        "level": "{{ message.tags }}",
        "text": {{ message|escapejs|safe }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]

  /* Performance optimizations for mobile */
@media (max-width: 768px) {
  * {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
  }
  
  .lead-header::before,
  .step-circle,
  .progress-line {
    /* Reduce animations on mobile for better performance */
    animation: none;
  }
  
  .toast {
    /* Hardware acceleration for smoother animations */
    transform: translate3d(120%, 0, 0);
  }
  
  .toast.show {
    transform: translate3d(0, 0, 0);
  }
}

</script>
{% endif %}

<div class="container">
  <!-- ============================================
       TOP HEADER WITH EXPANDED CLIENT INFO
       ============================================ -->
  <div class="lead-header">
    <div class="header-content">
      <div class="header-top">
        <div>
          <h1 class="lead-title">{{ lead.company_name }}</h1>
          <span class="lead-id">{{ lead.lead_code }}</span>
        </div>
        <span class="stage-badge stage-{{ requirement.sales_stage }}">
          {{ requirement.get_sales_stage_display }}
        </span>
      </div>

      <!-- First Row: Location, Contact Person, Sales Person -->
      <div class="header-info-grid">
        <div class="header-info-item">
          <div class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <div class="header-text">
            <div class="header-label">Location</div>
            <div class="header-value">{{ lead.city }}, {{ lead.state }}</div>
          </div>
        </div>

        <div class="header-info-item">
          <div class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="header-text">
            <div class="header-label">Contact Person</div>
            <div class="header-value">{{ lead.contact_name|default:"Not specified" }}</div>
          </div>
        </div>

        <div class="header-info-item">
          <div class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="10" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div class="header-text">
            <div class="header-label">Sales Person</div>
            <div class="header-value">{{ requirement.assigned_sales_person }}</div>
          </div>
        </div>
      </div>

      <!-- Second Row: Client Type, Phone, Email -->
      <div class="header-info-grid">
        <div class="header-info-item">
          <div class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
          </div>
          <div class="header-text">
            <div class="header-label">Client Type</div>
            <div class="header-value">
              {{ requirement.client_type_main }}{% if requirement.client_type_detail %} ‚Ä¢ {{ requirement.client_type_detail }}{% endif %}
            </div>
          </div>
        </div>

        <div class="header-info-item">
          <div class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
          </div>
          <div class="header-text">
            <div class="header-label">Phone Number</div>
            <div class="header-value">{{ lead.contact_phone|default:"Not available" }}</div>
          </div>
        </div>

        <div class="header-info-item">
          <div class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </div>
          <div class="header-text">
            <div class="header-label">Email Address</div>
            <div class="header-value">{{ lead.contact_email|default:"Not available" }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================
       ORDER PROGRESS TRACKER
       ============================================ -->
  <div class="progress-tracker">
    <h2 class="progress-title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <path d="M22 4L12 14.01l-3-3"></path>
      </svg>
      Order Progress
    </h2>

    <div class="progress-steps">
      <div class="progress-line">
        <div class="progress-line-fill" id="progressFill"></div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'costing_created' %}active{% elif requirement.sales_stage != 'costing_created' %}completed{% endif %}" onclick="selectStage('costing_created')">
        <div class="step-circle">1</div>
        <div class="step-label">Costing Created</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'quotation_created' %}active{% elif requirement.sales_stage == 'quotation_sent' or requirement.sales_stage == 'quotation_revision' or requirement.sales_stage == 'quotation_accepted' or requirement.sales_stage == 'po_received' or requirement.sales_stage == 'oa_created' or requirement.sales_stage == 'oa_sent' or requirement.sales_stage == 'oa_revision' or requirement.sales_stage == 'oa_accepted' or requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('quotation_created')">
        <div class="step-circle">2</div>
        <div class="step-label">Quotation Created</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'quotation_sent' %}active{% elif requirement.sales_stage == 'quotation_revision' or requirement.sales_stage == 'quotation_accepted' or requirement.sales_stage == 'po_received' or requirement.sales_stage == 'oa_created' or requirement.sales_stage == 'oa_sent' or requirement.sales_stage == 'oa_revision' or requirement.sales_stage == 'oa_accepted' or requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('quotation_sent')">
        <div class="step-circle">3</div>
        <div class="step-label">Quotation Sent</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'quotation_accepted' %}active{% elif requirement.sales_stage == 'po_received' or requirement.sales_stage == 'oa_created' or requirement.sales_stage == 'oa_sent' or requirement.sales_stage == 'oa_revision' or requirement.sales_stage == 'oa_accepted' or requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('quotation_accepted')">
        <div class="step-circle">4</div>
        <div class="step-label">Quotation Accepted</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'po_received' %}active{% elif requirement.sales_stage == 'oa_created' or requirement.sales_stage == 'oa_sent' or requirement.sales_stage == 'oa_revision' or requirement.sales_stage == 'oa_accepted' or requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('po_received')">
        <div class="step-circle">5</div>
        <div class="step-label">PO Received</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'oa_created' %}active{% elif requirement.sales_stage == 'oa_sent' or requirement.sales_stage == 'oa_revision' or requirement.sales_stage == 'oa_accepted' or requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('oa_created')">
        <div class="step-circle">6</div>
        <div class="step-label">OA Created</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'oa_sent' %}active{% elif requirement.sales_stage == 'oa_revision' or requirement.sales_stage == 'oa_accepted' or requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('oa_sent')">
        <div class="step-circle">7</div>
        <div class="step-label">OA Sent</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'oa_accepted' %}active{% elif requirement.sales_stage == 'order_completed' %}completed{% endif %}" onclick="selectStage('oa_accepted')">
        <div class="step-circle">8</div>
        <div class="step-label">OA Accepted</div>
      </div>

      <div class="progress-step {% if requirement.sales_stage == 'order_completed' %}active completed{% endif %}" onclick="selectStage('order_completed')">
        <div class="step-circle">‚úì</div>
        <div class="step-label">Order Completed</div>
      </div>
    </div>

    {% if requirement.current_remark %}
    <div class="latest-update">
      <div class="update-label">Latest Update</div>
      <div class="update-text">{{ requirement.current_remark }}</div>
    </div>
    {% endif %}
  </div>


  <!-- ============================================
       STAGE UPDATE FORM
       ============================================ -->
  <div class="stage-update-card">
    <div class="update-header">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
      <span class="update-title">Update Order Progress</span>

      <div class="dropdown-container">
        <div class="dropdown-trigger" onclick="toggleDropdown()" id="dropdown-trigger">
          <span id="selected-stage-text">{{ requirement.get_sales_stage_display }}</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>

        <div class="dropdown-menu" id="dropdown-menu">
          <div class="dropdown-item {% if requirement.sales_stage == 'costing_created' %}selected{% endif %}" onclick="selectDropdownStage('costing_created', 'Costing Created', 'üí∞')">
            <span style="font-size: 20px">üí∞</span>
            <span>Costing Created</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'quotation_created' %}selected{% endif %}" onclick="selectDropdownStage('quotation_created', 'Quotation Created', 'üìÑ')">
            <span style="font-size: 20px">üìÑ</span>
            <span>Quotation Created</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'quotation_sent' %}selected{% endif %}" onclick="selectDropdownStage('quotation_sent', 'Quotation Sent', 'üì§')">
            <span style="font-size: 20px">üì§</span>
            <span>Quotation Sent</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'quotation_revision' %}selected{% endif %}" onclick="selectDropdownStage('quotation_revision', 'Quotation Revision', '‚úèÔ∏è')">
            <span style="font-size: 20px">‚úèÔ∏è</span>
            <span>Quotation Revision</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'quotation_accepted' %}selected{% endif %}" onclick="selectDropdownStage('quotation_accepted', 'Quotation Accepted', '‚úÖ')">
            <span style="font-size: 20px">‚úÖ</span>
            <span>Quotation Accepted</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'po_received' %}selected{% endif %}" onclick="selectDropdownStage('po_received', 'PO Received', 'üì•')">
            <span style="font-size: 20px">üì•</span>
            <span>PO Received</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'oa_created' %}selected{% endif %}" onclick="selectDropdownStage('oa_created', 'OA Created', 'üìã')">
            <span style="font-size: 20px">üìã</span>
            <span>OA Created</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'oa_sent' %}selected{% endif %}" onclick="selectDropdownStage('oa_sent', 'OA Sent', 'üì®')">
            <span style="font-size: 20px">üì®</span>
            <span>OA Sent</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'oa_revision' %}selected{% endif %}" onclick="selectDropdownStage('oa_revision', 'OA Revision', 'üîÑ')">
            <span style="font-size: 20px">üîÑ</span>
            <span>OA Revision</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'oa_accepted' %}selected{% endif %}" onclick="selectDropdownStage('oa_accepted', 'OA Accepted', 'üëç')">
            <span style="font-size: 20px">üëç</span>
            <span>OA Accepted</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'order_completed' %}selected{% endif %}" onclick="selectDropdownStage('order_completed', 'Order Completed', 'üéâ')">
            <span style="font-size: 20px">üéâ</span>
            <span>Order Completed</span>
          </div>
          <div class="dropdown-item {% if requirement.sales_stage == 'order_lost' %}selected{% endif %}" onclick="selectDropdownStage('order_lost', 'Order Lost', '‚ùå')">
            <span style="font-size: 20px">‚ùå</span>
            <span>Order Lost</span>
          </div>
        </div>
      </div>
    </div>

    <form method="POST" id="stageUpdateForm" onsubmit="return validateStageUpdate()">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_stage" />
      <input type="hidden" name="sales_stage" id="selectedStage" value="{{ requirement.sales_stage }}" />

      <div class="update-form-grid">
        <div>
          <label class="form-label">Update Remark *</label>
          <textarea name="remark" class="form-textarea" placeholder="Enter detailed update about this progress change..." required></textarea>
        </div>
        <div>
          <label class="form-label">Progress Updated Date</label>
          <input type="date" name="followup_date" class="form-input" />
        </div>
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button type="submit" class="btn btn-success">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          </svg>
          Update Progress
        </button>
      </div>
    </form>
  </div>

  <!-- ============================================
       UNIFIED TANK DETAILS
       ============================================ -->
  <div class="tank-details-card">
    <h3 class="card-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
      </svg>
      Tank Specifications
    </h3>

    <!-- Top Info: Application & Location -->
    <div class="tank-top-info">
      <div class="info-field">
        <div class="info-label">Tank Application</div>
        <div class="info-value">{{ requirement.tank_application }}</div>
      </div>
      {% if requirement.tank_location %}
      <div class="info-field">
        <div class="info-label">Tank Location</div>
        <div class="info-value">{{ requirement.tank_location }}</div>
      </div>
      {% endif %}
    </div>

    <!-- Tank Grid -->
    {% if requirement.tanks_json %}
    <div class="tank-grid">
      <div class="tank-grid-header">
        <div class="grid-header-cell">Tank Type</div>
        <div class="grid-header-cell">Capacity</div>
        <div class="grid-header-cell">Quantity</div>
      </div>
      {% for tank in requirement.tanks_json %}
      <div class="tank-grid-row">
        <div class="grid-cell">{{ tank.tank_type }}</div>
        <div class="grid-cell">{{ tank.capacity }}</div>
        <div class="grid-cell">{{ tank.quantity }}</div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="tank-empty">
      <div style="font-weight: 600; margin-bottom: 4px;">No Tank Details</div>
      <div style="font-size: 13px;">Tank information will appear here</div>
    </div>
    {% endif %}
  </div>

  <!-- ============================================
       MEETING SCHEDULER
       ============================================ -->
  <div class="meeting-card">
    <h3 class="card-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      Schedule Meeting
    </h3>

    <form method="POST" onsubmit="return validateMeetingSchedule()">
      {% csrf_token %}
      <input type="hidden" name="action" value="schedule_meeting" />

      <div class="meeting-form-grid">
        <div>
          <label class="form-label">Meeting Date</label>
          <input type="date" name="meeting_date" class="form-input" placeholder="Select meeting date" required />
        </div>
        <div>
          <label class="form-label">Meeting Notes</label>
          <textarea name="notes" class="form-textarea" placeholder="Enter meeting agenda, participants, or discussion points..."></textarea>
        </div>
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button type="submit" class="btn btn-success">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Schedule Meeting
        </button>
      </div>
    </form>
  </div>

  <!-- ============================================
       FINAL DECISION HUB
       ============================================ -->
  <div class="decision-card">
    <div class="decision-header">
      <h2 class="decision-title">Final Lead Decision</h2>
      <p class="decision-subtitle">Select the final status for this lead. This action will move the lead to the appropriate section.</p>
    </div>

    <div class="decision-options">
      <!-- Customer -->
      <button type="button" class="decision-btn customer" onclick="openDecisionModal('customer')">
        <div class="decision-icon">‚úÖ</div>
        <div class="decision-label">Convert to Customer</div>
        <div class="decision-desc">Order successfully completed</div>
      </button>

      <!-- Regret -->
      <button type="button" class="decision-btn regret" onclick="openDecisionModal('regret')">
        <div class="decision-icon">‚ùå</div>
        <div class="decision-label">Mark as Regret</div>
        <div class="decision-desc">Lead opted for competitor</div>
      </button>

      <!-- Lost Order -->
      <button type="button" class="decision-btn lost" onclick="openDecisionModal('lost')">
        <div class="decision-icon">‚ö†Ô∏è</div>
        <div class="decision-label">Mark as Lost Order</div>
        <div class="decision-desc">Order not converted</div>
      </button>

    </div>
  </div>

  <!-- ============================================
       PROSPECT STAGE CALL HISTORY
       ============================================ -->
  {% if call_history.exists %}
  <div class="history-card">
    <h3 class="card-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
      </svg>
      Prospect Stage Call History ({{ call_history.count }} {{ call_history.count|pluralize:"call,calls" }})
    </h3>

    <div class="timeline">
      {% for history_item in call_history %}
      <div class="timeline-item">
        <div class="timeline-dot {% if history_item.outcome == 'yes' %}success{% elif history_item.outcome == 'reconnect' %}warning{% endif %}">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="12"></circle>
          </svg>
        </div>
        <div class="timeline-content {% if history_item.outcome == 'yes' %}success{% elif history_item.outcome == 'reconnect' %}warning{% endif %}">
          <div class="timeline-title">
            Outcome: <strong>{{ history_item.get_outcome_display }}</strong>
          </div>
          <div class="timeline-meta">
            {{ history_item.actual_call_date|date:"d M Y" }} ‚Ä¢ 
            {% if history_item.created_by.get_full_name %}
              {{ history_item.created_by.get_full_name }}
            {% else %}
              {{ history_item.created_by.username }}
            {% endif %}
            {% if history_item.expected_call_date %}
              ‚Ä¢ Expected: {{ history_item.expected_call_date|date:"d M Y" }}
            {% endif %}
          </div>
          {% if history_item.remark %}
          <div class="timeline-text">
            <strong>Remark:</strong> {{ history_item.remark }}
          </div>
          {% else %}
          <div class="timeline-text" style="color: var(--text-secondary); font-style: italic;">
            No remark provided
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- ============================================
       SALES STAGE ACTIVITY HISTORY
       ============================================ -->
  <div class="history-card">
    <h3 class="card-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      Sales Stage Activity History ({{ history.count }} {{ history.count|pluralize:"event,events" }})
    </h3>

    <div class="timeline">
      {% for history_item in history %}
      <div class="timeline-item">
        <div class="timeline-dot {% if 'completed' in history_item.to_stage or 'accepted' in history_item.to_stage %}success{% endif %}">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="12"></circle>
          </svg>
        </div>
        <div class="timeline-content {% if 'completed' in history_item.to_stage or 'accepted' in history_item.to_stage %}success{% endif %}">
          <div class="timeline-title">
            Stage: <strong class="stage-text">{{ history_item.to_stage }}</strong>
          </div>
          <div class="timeline-meta">
            {{ history_item.changed_at|date:"d M Y ‚Ä¢ h:i A" }} ‚Ä¢ 
            {% if history_item.changed_by.get_full_name %}
              {{ history_item.changed_by.get_full_name }}
            {% else %}
              {{ history_item.changed_by.username }}
            {% endif %}
          </div>
          {% if history_item.notes %}
          <div class="timeline-text">
            <strong>Remark:</strong> {{ history_item.notes }}
          </div>
          {% else %}
          <div class="timeline-text" style="color: var(--text-secondary); font-style: italic;">
            No remark provided
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.3; margin-bottom: 12px;">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <div style="font-weight: 600; margin-bottom: 4px;">No History Yet</div>
        <div style="font-size: 13px;">Progress changes will appear here</div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ============================================
     MODAL FOR FINAL REMARK
     ============================================ -->
<div class="modal-overlay" id="decisionModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon" id="modalIcon">
        <span id="modalIconEmoji"></span>
      </div>
      <h3 class="modal-title" id="modalTitle">Confirm Decision</h3>
    </div>

    <div class="modal-body">
      <p class="modal-description" id="modalDescription"></p>

      <form method="POST" id="decisionForm">
        {% csrf_token %}
        <input type="hidden" name="action" id="decisionAction" value="" />
        
        <label class="form-label">Final Remark *</label>
        <textarea name="final_remark" class="form-textarea" placeholder="Please provide a reason for this decision..." required rows="4"></textarea>
      </form>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-modal-cancel" onclick="closeDecisionModal()">Cancel</button>
      <button type="button" class="btn-modal-confirm" id="confirmBtn" onclick="submitDecision()">Confirm</button>
    </div>
  </div>
</div>

<script>
  // Toast Notification System
  function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = {
      success: '‚úÖ',
      warning: '‚ö†Ô∏è',
      error: '‚ùå',
      info: '‚ÑπÔ∏è'
    };
    
    toast.innerHTML = `
      <div class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);
    
    // Auto remove
    setTimeout(() => {
      if (toast.parentElement) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 300);
      }
    }, duration);
  }

  // ============================================
  // PRODUCTION-GRADE DJANGO MESSAGES HANDLER
  // ============================================
  function loadDjangoMessages() {
    const script = document.getElementById('django-messages');
    if (!script) return;

    try {
      const messages = JSON.parse(script.textContent);
      
      messages.forEach(msg => {
        const type = msg.level || 'info';
        const titleMap = {
          success: 'Success',
          error: 'Error',
          warning: 'Warning',
          info: 'Info'
        };

        showToast(
          type,
          titleMap[type] || 'Info',
          msg.text
        );
      });
    } catch (error) {
      console.error('Error parsing Django messages:', error);
      showToast('error', 'System Error', 'Could not load messages');
    }
  }

  // Form validation with toast notifications
  function validateStageUpdate() {
    const stage = document.getElementById('selectedStage').value;
    const currentStage = '{{ requirement.sales_stage }}';
    
    // Check if stage is different from current
    if (stage === currentStage) {
      showToast('warning', 'No Change', 'Please select a different stage to update progress.');
      return false;
    }
    
    // Check if stage is going backwards (with confirmation)
    const stagesOrder = [
      'costing_created', 'quotation_created', 'quotation_sent',
      'quotation_accepted', 'po_received', 'oa_created',
      'oa_sent', 'oa_accepted', 'order_completed'
    ];
    
    const currentIndex = stagesOrder.indexOf(currentStage);
    const selectedIndex = stagesOrder.indexOf(stage);
    
    if (selectedIndex < currentIndex && selectedIndex !== -1) {
      const confirmed = confirm('You are moving to a previous stage. Are you sure you want to go backwards?');
      if (!confirmed) {
        showToast('info', 'Update Cancelled', 'Stage update was cancelled.');
        return false;
      }
    }
    
    return true;
  }

  function validateMeetingSchedule() {
    const dateInput = document.querySelector('input[name="meeting_date"]');

    if (!dateInput.value) {
      alert("Please select a meeting date");
      return false;
    }

    // Convert YYYY-MM-DD ‚Üí Date safely
    const selectedDate = new Date(dateInput.value + "T00:00:00");
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedDate < today) {
      alert("Meeting date cannot be in the past");
      return false;
    }

    return true;
  }


  // Dropdown functionality
  function toggleDropdown() {
    const menu = document.getElementById("dropdown-menu");
    const trigger = document.getElementById("dropdown-trigger");
    menu.classList.toggle("show");
    trigger.classList.toggle("open");
  }

  function selectDropdownStage(stage, displayName, emoji) {
    document.getElementById("selectedStage").value = stage;
    document.getElementById("selected-stage-text").textContent = displayName;

    document.querySelectorAll(".dropdown-item").forEach((item) => {
      item.classList.remove("selected");
    });
    event.currentTarget.classList.add("selected");

    document.getElementById("dropdown-menu").classList.remove("show");
    document.getElementById("dropdown-trigger").classList.remove("open");

    updateProgressBar();
    
   
  }

  document.addEventListener("click", function (event) {
    const dropdown = document.querySelector(".dropdown-container");
    if (dropdown && !dropdown.contains(event.target)) {
      document.getElementById("dropdown-menu").classList.remove("show");
      document.getElementById("dropdown-trigger").classList.remove("open");
    }
  });

  function selectStage(stage) {
    document.getElementById("selectedStage").value = stage;
    updateProgressBar();
  }

  function updateProgressBar() {
    const stages = [
      "costing_created", "quotation_created", "quotation_sent",
      "quotation_accepted", "po_received", "oa_created",
      "oa_sent", "oa_accepted", "order_completed",
    ];
    const currentStage = document.getElementById("selectedStage").value || "{{ requirement.sales_stage }}";
    const currentIndex = stages.indexOf(currentStage);
    const progressPercent = (currentIndex / (stages.length - 1)) * 90;

    const progressFill = document.getElementById("progressFill");
    if (progressFill) {
      progressFill.style.width = progressPercent + "%";
    }
  }

  function formatStageText() {
    document.querySelectorAll(".stage-text").forEach((el) => {
      const text = el.textContent.trim();
      el.textContent = text.toUpperCase().replace(/_/g, " ");
    });
  }

  // Decision Modal Functions
  function openDecisionModal(type) {
    const modal = document.getElementById("decisionModal");
    const icon = document.getElementById("modalIcon");
    const iconEmoji = document.getElementById("modalIconEmoji");
    const title = document.getElementById("modalTitle");
    const description = document.getElementById("modalDescription");
    const confirmBtn = document.getElementById("confirmBtn");
    const action = document.getElementById("decisionAction");

    // Reset classes
    icon.className = "modal-icon";
    confirmBtn.className = "btn-modal-confirm";

    if (type === 'regret') {
      icon.classList.add('regret');
      confirmBtn.classList.add('regret');
      iconEmoji.textContent = "‚ùå";
      title.textContent = "Mark as Regret";
      description.textContent = "This lead will be moved to the Regret section. Please provide a reason for marking this lead as regret (e.g., competitor chosen, pricing issues).";
      action.value = "mark_regret";
    } else if (type === 'lost') {
      icon.classList.add('lost');
      confirmBtn.classList.add('lost');
      iconEmoji.textContent = "‚ö†Ô∏è";
      title.textContent = "Mark as Lost Order";
      description.textContent = "This lead will be moved to the Lost Orders section. Please provide a reason why this order was not converted.";
      action.value = "mark_lost";
    } else if (type === 'customer') {
      icon.classList.add('customer');
      confirmBtn.classList.add('customer');
      iconEmoji.textContent = "‚úÖ";
      title.textContent = "Convert to Customer";
      description.textContent = "This lead will be converted to a Customer. Please confirm the order completion details.";
      action.value = "mark_customer";
    }

    modal.classList.add("show");
  }

  function closeDecisionModal() {
    document.getElementById("decisionModal").classList.remove("show");
    document.getElementById("decisionForm").reset();
    showToast('info', 'Decision Cancelled', 'The decision action was cancelled.');
  }

  function submitDecision() {
    const form = document.getElementById("decisionForm");
    const action = document.getElementById("decisionAction").value;
    
    if (form.checkValidity()) {
      let actionText = '';
      if (action === 'mark_regret') actionText = 'marked as Regret';
      else if (action === 'mark_lost') actionText = 'marked as Lost Order';
      else if (action === 'mark_customer') actionText = 'converted to Customer';
      
      showToast('success', 'Decision Submitted', `Lead will be ${actionText}. Processing...`);
      form.submit();
    } else {
      showToast('error', 'Validation Error', 'Please provide a final remark before submitting.');
      form.reportValidity();
    }
  }

  // Close modal when clicking outside
  document.getElementById("decisionModal").addEventListener("click", function(e) {
    if (e.target === this) {
      closeDecisionModal();
    }
  });

  // Initialize everything on page load
  document.addEventListener("DOMContentLoaded", function () {
    updateProgressBar();
    formatStageText();
    loadDjangoMessages(); // Load Django messages safely
    
  });


  // ============================================
// FLATPICKR INITIALIZATION FOR ALL DATE FIELDS
// ============================================
document.addEventListener("DOMContentLoaded", function () {
  // Get today's date in YYYY-MM-DD format
  const today = new Date().toISOString().split('T')[0];
  
  // ========================================
  // 1. PROGRESS UPDATED DATE (Auto-fill + Flatpickr)
  // ========================================
  const progressDateField = document.querySelector('input[name="followup_date"]');
  
  if (progressDateField) {
    // Auto-fill with today's date
    progressDateField.value = today;
    
    // Initialize flatpickr with enhanced UI
    flatpickr(progressDateField, {
      dateFormat: "Y-m-d",
      defaultDate: today,
      allowInput: true,
      clickOpens: true,
      disableMobile: false,
      locale: {
        firstDayOfWeek: 1 // Monday
      },
      onChange: function(selectedDates, dateStr, instance) {
        console.log('Progress date changed to:', dateStr);
        showToast('info', 'Date Updated', `Progress date set to ${dateStr}`);
      },
      onReady: function(selectedDates, dateStr, instance) {
      }
    });
  }
  
  
  
  // ========================================
  // 3. INITIALIZE ALL OTHER DATE FIELDS
  // ========================================
  const allDateFields = document.querySelectorAll('input[type="date"]:not([name="followup_date"]):not([name="meeting_date"])');
  
  allDateFields.forEach(field => {
    flatpickr(field, {
      dateFormat: "Y-m-d",
      allowInput: true,
      clickOpens: true,
      disableMobile: false,
      locale: {
        firstDayOfWeek: 1
      }
    });
  });
  
  console.log(`‚úì Flatpickr initialized on ${allDateFields.length + 2} date fields`);
});


// ============================================
// FLATPICKR INITIALIZATION WITH ENHANCED UX
// ============================================
document.addEventListener("DOMContentLoaded", function () {
  const today = new Date().toISOString().split('T')[0];
  
  // Progress Updated Date - Auto-fill + Enhanced Flatpickr
  const progressDateField = document.querySelector('input[name="followup_date"]');
  
  if (progressDateField) {
    progressDateField.value = today;
    
    flatpickr(progressDateField, {
      dateFormat: "Y-m-d",
      defaultDate: today,
      allowInput: true,
      clickOpens: true,
      disableMobile: false,
      animate: true,
      locale: {
        firstDayOfWeek: 1
      },
      onReady: function(selectedDates, dateStr, instance) {
        // Add calendar icon to the input wrapper
        const wrapper = instance.calendarContainer;
        wrapper.style.animation = 'fadeIn 0.2s ease-out';
        
        setTimeout(() => {
          showToast('info','Progress date set to today. Click to change.');
        }, 500);
      },
      
    });
  }
  
  // Meeting Date & Time - Enhanced with validation
  const meetingDateField = document.querySelector('input[name="meeting_date"]');

    if (meetingDateField) {
      flatpickr(meetingDateField, {
        enableTime: false,        // ‚úÖ NO TIME
        dateFormat: "Y-m-d",      // ‚úÖ DATE ONLY
        minDate: "today",
        allowInput: true,
        clickOpens: true,
        disableMobile: false,
        locale: {
          firstDayOfWeek: 1
        }
      });
    }

  
  // Initialize all other date fields
  const allDateFields = document.querySelectorAll('input[type="date"]:not([name="followup_date"]):not([name="meeting_date"])');
  
  allDateFields.forEach(field => {
    flatpickr(field, {
      dateFormat: "Y-m-d",
      allowInput: true,
      clickOpens: true,
      disableMobile: false,
      animate: true,
      locale: {
        firstDayOfWeek: 1
      }
    });
  });
  
  console.log(`‚úì Flatpickr initialized on ${allDateFields.length + 2} date fields`);
});

  // Make tank grid rows mobile-friendly
function makeTankGridMobile() {
  if (window.innerWidth <= 768) {
    const rows = document.querySelectorAll('.tank-grid-row');
    const labels = ['Tank Type', 'Capacity', 'Quantity'];
    
    rows.forEach((row, rowIndex) => {
      const cells = row.querySelectorAll('.grid-cell');
      cells.forEach((cell, cellIndex) => {
        cell.setAttribute('data-label', labels[cellIndex] || '');
      });
    });
  }
}

// Call this on load and resize
document.addEventListener('DOMContentLoaded', function() {
  makeTankGridMobile();
  window.addEventListener('resize', makeTankGridMobile);
});
</script>

{% endblock %}